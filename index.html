<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bodega Tech Pro - Sistema de Control</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #1e293b; --accent: #2563eb; --success: #22c55e; --danger: #ef4444; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f8fafc; }
        .hidden { display: none !important; }
        nav { background: var(--primary); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .container { padding: 20px; max-width: 600px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: var(--accent); color: white; border: none; font-weight: bold; cursor: pointer; }
        #qrcode-box canvas { max-width: 100%; height: auto; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; }
    </style>
</head>
<body>

<nav id="navbar" class="hidden">
    <strong>BODEGA TECH üì¶</strong>
    <button onclick="location.reload()" style="width: auto; background: var(--danger); padding: 5px 10px;">Salir</button>
</nav>

<div class="container">
    <div id="view-login" class="card">
        <h2>Ingreso al Sistema</h2>
        <input type="email" id="email" placeholder="admin@ciapanama.com">
        <input type="password" id="pass" placeholder="Contrase√±a">
        <button onclick="handleLogin()">Entrar</button>
    </div>

    <div id="view-admin" class="hidden">
        <div class="card">
            <h3>üì¶ Registrar Equipo Nuevo</h3>
            <input type="text" id="p-nombre" placeholder="Nombre del Equipo">
            <input type="number" id="p-stock" placeholder="Cantidad Inicial">
            <input type="date" id="p-fecha">
            <select id="p-garantia">
                <option value="12">Garant√≠a 12 Meses</option>
                <option value="24">Garant√≠a 24 Meses</option>
            </select>
            <button onclick="guardarProductoCloud()" style="background: var(--success);">Guardar y Generar QR</button>
            <div id="qrcode-box" style="display: flex; justify-content: center; margin-top: 15px;"></div>
        </div>

        <div class="card">
            <h3>üìä Gesti√≥n y Reportes</h3>
            <button onclick="exportarExcel()" style="background: #065f46;">üì• Descargar Reporte Semanal (Excel)</button>
            <button onclick="cargarHistorial()" style="background: var(--primary); margin-top: 10px;">üìã Ver Historial de Firmas</button>
        </div>

        <div id="historial-container" class="hidden card">
            <table id="tabla-historial">
                <thead><tr><th>Fecha</th><th>Equipo</th><th>Ver</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // PEGA AQU√ç TUS CREDENCIALES DE FIREBASE
    const firebaseConfig = {
        apiKey: "TU_API_KEY",
        authDomain: "TU_PROYECTO.firebaseapp.com",
        projectId: "TU_PROYECTO",
        storageBucket: "TU_PROYECTO.appspot.com",
        messagingSenderId: "TU_ID",
        appId: "TU_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.handleLogin = function() {
        const user = document.getElementById('email').value.toLowerCase();
        if(user === 'panamacia@gmail.com' || user.includes('admin')) {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-admin').classList.remove('hidden');
            document.getElementById('navbar').classList.remove('hidden');
        } else {
            alert("Acceso denegado: Usa el correo de Administrador");
        }
    };

    window.guardarProductoCloud = async function() {
        const nom = document.getElementById('p-nombre').value;
        const stock = document.getElementById('p-stock').value;
        if(!nom || !stock) return alert("Faltan datos");

        const qrID = "QR-" + Date.now();
        try {
            await addDoc(collection(db, "productos"), {
                nombre: nom,
                stock: parseInt(stock),
                fecha: document.getElementById('p-fecha').value,
                garantia: document.getElementById('p-garantia').value,
                codigo_qr: qrID
            });

            const qrContainer = document.getElementById('qrcode-box');
            qrContainer.innerHTML = '<canvas id="canvas-qr"></canvas>';
            QRCode.toCanvas(document.getElementById('canvas-qr'), qrID, { width: 160 }, function(err) {
                if(err) console.error(err);
                alert("¬°Guardado y QR generado!");
            });
        } catch(e) { alert("Error Firebase: Revisa las Reglas de Firestore"); }
    };

    window.exportarExcel = async function() {
        const snap = await getDocs(collection(db, "entregas"));
        const rows = snap.docs.map(d => d.data());
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Reporte");
        XLSX.writeFile(wb, "Reporte_Bodega.xlsx");
    };

    window.cargarHistorial = async function() {
        const snap = await getDocs(collection(db, "entregas"));
        const body = document.querySelector("#tabla-historial tbody");
        body.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            body.innerHTML += `<tr><td>${d.fecha}</td><td>${d.equipo}</td><td><button style="padding:2px">üëÅÔ∏è</button></td></tr>`;
        });
        document.getElementById('historial-container').classList.remove('hidden');
    };
</script>
</body>
</html>
